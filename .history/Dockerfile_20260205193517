FROM ghcr.io/puppeteer/puppeteer:22

WORKDIR /app

# Install VNC server and display tools
USER root
RUN apt-get update && apt-get install -y \
    x11vnc \
    xvfb \
    fluxbox \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install noVNC for web access
RUN git clone https://github.com/novnc/noVNC.git /opt/novnc && \
    git clone https://github.com/novnc/websockify.git /opt/novnc/utils/websockify

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy application code
COPY . .

# Create startup script
RUN echo '#!/bin/bash\n\
Xvfb :99 -screen 0 1280x720x24 &\n\
export DISPLAY=:99\n\
fluxbox &\n\
x11vnc -display :99 -forever -shared -rfbport 5900 &\n\
cd /opt/novnc && python3 utils/websockify/run 6080 localhost:5900 &\n\
sleep 2\n\
node script.js\n\
sleep infinity' > /app/start.sh && chmod +x /app/start.sh

# Expose VNC and noVNC ports
EXPOSE 5900 6080

# Run the startup script
CMD ["/app/start.sh"]
